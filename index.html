<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Human Substrate — Complete Model</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0f;
            color: #e8e8e8;
            overflow: hidden;
        }

        #container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        svg {
            width: 100%;
            height: 100%;
        }

        /* Links */
        .link-capacity {
            stroke: #334155;
            stroke-opacity: 0.25;
            fill: none;
            transition: stroke 0.3s ease, stroke-opacity 0.3s ease;
        }

        .link-capacity.cascade-active {
            stroke-opacity: 0.8;
            stroke: #fbbf24;
        }

        .link-capacity.cascade-danger {
            stroke-opacity: 0.9;
            stroke: #ef4444;
        }

        .link-capacity.cascade-boost {
            stroke-opacity: 0.9;
            stroke: #22c55e;
        }

        .link-capacity.drag-highlight {
            stroke-opacity: 0.9;
            stroke: #fbbf24;
            stroke-width: 2.5px;
        }

        /* Role lines */
        .role-line {
            stroke: #fbbf24;
            stroke-width: 1.5;
            stroke-dasharray: 4, 4;
            stroke-opacity: 0;
            fill: none;
            transition: stroke-opacity 0.3s ease;
            pointer-events: none;
        }

        .role-line.visible {
            stroke-opacity: 0.5;
        }

        /* Role labels */
        .role-label-bg {
            fill: rgba(10, 10, 15, 0.9);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .role-label-bg.visible {
            opacity: 1;
        }

        .role-label {
            font-size: 10px;
            font-weight: 500;
            fill: #fbbf24;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            text-anchor: middle;
        }

        .role-label.visible {
            opacity: 1;
        }

        .role-label.at-risk {
            fill: #f87171;
        }

        /* Nodes */
        .node-capacity {
            cursor: pointer;
            transition: opacity 0.3s ease;
        }

        .node-capacity circle.main-circle {
            stroke-width: 3px;
            transition: all 0.4s ease;
        }

        .node-capacity text.node-label {
            font-size: 10px;
            font-weight: 500;
            fill: #e2e8f0;
            pointer-events: none;
            text-anchor: middle;
        }

        .node-capacity .health-ring {
            fill: none;
            stroke-width: 4px;
            transition: stroke-dasharray 0.5s ease, stroke 0.5s ease;
        }

        .node-capacity .health-text {
            font-size: 9px;
            fill: #94a3b8;
            text-anchor: middle;
            font-weight: 600;
        }

        /* Health states */
        .health-healthy .main-circle { stroke: rgba(34, 197, 94, 0.7); }
        .health-stressed .main-circle { stroke: rgba(251, 191, 36, 0.8); }
        .health-degraded .main-circle { stroke: rgba(249, 115, 22, 0.9); }
        .health-critical .main-circle { stroke: rgba(239, 68, 68, 1); }

        .health-critical .main-circle {
            animation: pulse-critical 1.2s ease-in-out infinite;
        }

        @keyframes pulse-critical {
            0%, 100% { filter: drop-shadow(0 0 6px rgba(239, 68, 68, 0.5)); }
            50% { filter: drop-shadow(0 0 14px rgba(239, 68, 68, 0.8)); }
        }

        .node-capacity.selected .main-circle {
            stroke: #fbbf24 !important;
            stroke-width: 4px;
            filter: drop-shadow(0 0 10px rgba(251, 191, 36, 0.5));
        }

        .node-capacity.dragging .main-circle {
            stroke: #fbbf24 !important;
            stroke-width: 4px;
            filter: drop-shadow(0 0 12px rgba(251, 191, 36, 0.6));
        }

        .node-capacity.connected-drag .main-circle {
            stroke: rgba(251, 191, 36, 0.7) !important;
            stroke-width: 3px;
        }

        .node-capacity.faded-drag {
            opacity: 0.3;
        }

        /* Header */
        #header {
            position: absolute;
            top: 16px;
            left: 16px;
            z-index: 10;
        }

        #header h1 {
            font-size: 18px;
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 2px;
        }

        #header p {
            font-size: 11px;
            color: #64748b;
        }

        /* Control Panel */
        #controls {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid #334155;
            border-radius: 10px;
            padding: 14px;
            width: 200px;
            backdrop-filter: blur(8px);
        }

        #controls h3 {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #64748b;
            margin-bottom: 10px;
        }

        .mode-buttons {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
        }

        .mode-btn {
            flex: 1;
            padding: 8px 6px;
            border: 1px solid #334155;
            border-radius: 6px;
            background: #1e293b;
            color: #94a3b8;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .mode-btn:hover {
            background: #334155;
        }

        .mode-btn.active {
            color: white;
        }

        .mode-btn.degrade.active {
            background: #dc2626;
            border-color: #dc2626;
        }

        .mode-btn.boost.active {
            background: #16a34a;
            border-color: #16a34a;
        }

        .mode-btn.view.active {
            background: #2563eb;
            border-color: #2563eb;
        }

        #reset-btn {
            width: 100%;
            padding: 8px;
            border: 1px solid #475569;
            border-radius: 6px;
            background: transparent;
            color: #94a3b8;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        #reset-btn:hover {
            background: #334155;
            color: #e2e8f0;
        }

        /* System Health */
        #system-health {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #334155;
        }

        #system-health .label {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #64748b;
            margin-bottom: 6px;
        }

        #health-bar {
            height: 6px;
            background: #1e293b;
            border-radius: 3px;
            overflow: hidden;
        }

        #health-fill {
            height: 100%;
            background: #22c55e;
            border-radius: 3px;
            transition: width 0.5s ease, background 0.5s ease;
        }

        #health-value {
            font-size: 18px;
            font-weight: 600;
            color: #22c55e;
            margin-top: 6px;
            transition: color 0.5s ease;
        }

        /* Drag Stats Panel - NEW */
        #drag-panel {
            position: absolute;
            bottom: 16px;
            left: 16px;
            width: 340px;
            background: rgba(30, 41, 59, 0.97);
            border: 1px solid #fbbf24;
            border-radius: 10px;
            padding: 16px;
            backdrop-filter: blur(10px);
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.25s ease;
            pointer-events: none;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.15);
        }

        #drag-panel.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        #drag-panel h3 {
            font-size: 14px;
            font-weight: 600;
            color: #fbbf24;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #drag-panel h3 .drag-icon {
            font-size: 12px;
            opacity: 0.7;
        }

        #drag-panel .subtitle {
            font-size: 10px;
            color: #64748b;
            margin-bottom: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        #drag-panel .section {
            margin-bottom: 14px;
        }

        #drag-panel .section:last-child {
            margin-bottom: 0;
        }

        #drag-panel .section-title {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #64748b;
            margin-bottom: 8px;
        }

        #drag-panel .dependency-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        #drag-panel .dependency-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 10px;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 6px;
            font-size: 11px;
        }

        #drag-panel .dep-name {
            color: #e2e8f0;
            font-weight: 500;
        }

        #drag-panel .dep-type {
            color: #94a3b8;
            font-size: 10px;
            padding: 2px 6px;
            background: rgba(71, 85, 105, 0.5);
            border-radius: 3px;
        }

        #drag-panel .dep-type.reinforces { background: rgba(59, 130, 246, 0.3); color: #93c5fd; }
        #drag-panel .dep-type.enables { background: rgba(34, 197, 94, 0.3); color: #86efac; }
        #drag-panel .dep-type.tensions { background: rgba(239, 68, 68, 0.3); color: #fca5a5; }
        #drag-panel .dep-type.supports { background: rgba(16, 185, 129, 0.3); color: #6ee7b7; }
        #drag-panel .dep-type.requires { background: rgba(249, 115, 22, 0.3); color: #fdba74; }

        #drag-panel .cascade-preview {
            padding: 10px 12px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 6px;
        }

        #drag-panel .cascade-preview.boost-preview {
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.3);
        }

        #drag-panel .cascade-title {
            font-size: 10px;
            color: #f87171;
            font-weight: 600;
            margin-bottom: 6px;
        }

        #drag-panel .cascade-preview.boost-preview .cascade-title {
            color: #4ade80;
        }

        #drag-panel .cascade-effects {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        #drag-panel .cascade-effect {
            font-size: 10px;
            padding: 3px 7px;
            background: rgba(239, 68, 68, 0.2);
            border-radius: 3px;
            color: #fca5a5;
        }

        #drag-panel .cascade-effect.positive {
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
        }

        #drag-panel .impact-stat {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #334155;
        }

        #drag-panel .impact-label {
            font-size: 10px;
            color: #94a3b8;
        }

        #drag-panel .impact-value {
            font-size: 14px;
            font-weight: 600;
            color: #f87171;
        }

        #drag-panel .impact-value.positive {
            color: #4ade80;
        }

        /* Info Panel - Right side */
        #info-panel {
            position: absolute;
            top: 220px;
            right: 16px;
            width: 200px;
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid #334155;
            border-radius: 10px;
            padding: 14px;
            backdrop-filter: blur(8px);
            opacity: 0;
            transform: translateX(10px);
            transition: all 0.3s ease;
            pointer-events: none;
            max-height: calc(100vh - 240px);
            overflow-y: auto;
        }

        #info-panel.visible {
            opacity: 1;
            transform: translateX(0);
            pointer-events: auto;
        }

        #info-panel h2 {
            font-size: 14px;
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 3px;
        }

        #info-panel .cluster-badge {
            display: inline-block;
            font-size: 9px;
            font-weight: 500;
            padding: 2px 8px;
            border-radius: 8px;
            margin-bottom: 10px;
            color: white;
        }

        #info-panel .tooltip {
            font-size: 12px;
            color: #94a3b8;
            line-height: 1.4;
            margin-bottom: 10px;
            font-style: italic;
        }

        #info-panel .section-title {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #64748b;
            margin-bottom: 6px;
            margin-top: 10px;
        }

        #info-panel .roles-list {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        #info-panel .role-tag {
            font-size: 10px;
            padding: 3px 7px;
            background: #fbbf24;
            border-radius: 3px;
            color: #0a0a0f;
            font-weight: 500;
        }

        #info-panel .role-tag.at-risk {
            background: #f87171;
            color: white;
        }

        /* Outcome Panel - Bottom */
        #outcome-panel {
            position: absolute;
            bottom: 16px;
            left: 370px;
            right: 230px;
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid #334155;
            border-radius: 10px;
            padding: 14px 16px;
            backdrop-filter: blur(8px);
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            pointer-events: none;
        }

        #outcome-panel.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        #outcome-panel h3 {
            font-size: 13px;
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #outcome-panel .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        #outcome-panel p {
            font-size: 12px;
            color: #cbd5e1;
            line-height: 1.5;
            margin-bottom: 10px;
        }

        #outcome-panel .cascade-list {
            font-size: 11px;
            color: #94a3b8;
        }

        #outcome-panel .cascade-item {
            display: inline-block;
            padding: 2px 6px;
            background: rgba(239, 68, 68, 0.2);
            border-radius: 3px;
            margin: 2px 3px 2px 0;
            color: #fca5a5;
            font-size: 10px;
        }

        #outcome-panel .cascade-item.boost {
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
        }

        /* Legend */
        #legend {
            position: absolute;
            bottom: 16px;
            right: 16px;
            background: rgba(30, 41, 59, 0.9);
            border: 1px solid #334155;
            padding: 10px 14px;
            border-radius: 8px;
            backdrop-filter: blur(8px);
            width: 200px;
        }

        #legend h3 {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #64748b;
            margin-bottom: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 10px;
            color: #94a3b8;
            margin-bottom: 3px;
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 2px solid;
            background: transparent;
        }

        .legend-dot.healthy { border-color: #22c55e; }
        .legend-dot.stressed { border-color: #fbbf24; }
        .legend-dot.degraded { border-color: #f97316; }
        .legend-dot.critical { border-color: #ef4444; }

        #legend .divider {
            height: 1px;
            background: #334155;
            margin: 8px 0;
        }

        .legend-role {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 10px;
            color: #94a3b8;
            margin-bottom: 3px;
        }

        .legend-role-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        /* Instructions */
        #instructions {
            position: absolute;
            top: 70px;
            left: 16px;
            font-size: 10px;
            color: #64748b;
            max-width: 180px;
            line-height: 1.5;
        }

        #instructions strong {
            color: #94a3b8;
        }
    </style>
</head>
<body>
    <div id="container">
        <svg id="graph"></svg>

        <div id="header">
            <h1>The Human Substrate</h1>
            <p>Capacities, Carriers, Cascades</p>
        </div>

        <div id="instructions">
            <strong>Click</strong> to see who carries it<br>
            <strong>Drag</strong> to explore dependencies<br>
            <strong>Degrade/Boost</strong> to simulate change
        </div>

        <div id="controls">
            <h3>Intervention</h3>
            <div class="mode-buttons">
                <button class="mode-btn view active" data-mode="view">View</button>
                <button class="mode-btn degrade" data-mode="degrade">Degrade</button>
                <button class="mode-btn boost" data-mode="boost">Boost</button>
            </div>
            <button id="reset-btn">Reset System</button>

            <div id="system-health">
                <div class="label">System Health</div>
                <div id="health-bar">
                    <div id="health-fill" style="width: 100%"></div>
                </div>
                <div id="health-value">100%</div>
            </div>
        </div>

        <!-- NEW: Drag Stats Panel -->
        <div id="drag-panel">
            <h3><span class="drag-icon">⟷</span> <span id="drag-node-name">Node</span></h3>
            <div class="subtitle">Dependencies & Predicted Impact</div>

            <div class="section">
                <div class="section-title">Connected To</div>
                <div id="dependency-list" class="dependency-list"></div>
            </div>

            <div class="section">
                <div id="cascade-preview" class="cascade-preview">
                    <div class="cascade-title">If Degraded:</div>
                    <div id="cascade-effects" class="cascade-effects"></div>
                </div>
            </div>

            <div class="impact-stat">
                <span class="impact-label">Potential System Impact</span>
                <span id="impact-value" class="impact-value">-0%</span>
            </div>
        </div>

        <div id="info-panel">
            <h2 id="node-title"></h2>
            <span id="cluster-badge" class="cluster-badge"></span>
            <p id="node-tooltip" class="tooltip"></p>
            <div class="section-title">Carried By</div>
            <div id="roles-list" class="roles-list"></div>
        </div>

        <div id="outcome-panel">
            <h3><span class="status-dot"></span><span id="outcome-title"></span></h3>
            <p id="outcome-text"></p>
            <div class="cascade-list">
                <strong>Cascade:</strong>
                <span id="cascade-items"></span>
            </div>
        </div>

        <div id="legend">
            <h3>Health States</h3>
            <div class="legend-item"><div class="legend-dot healthy"></div>Healthy (80-100%)</div>
            <div class="legend-item"><div class="legend-dot stressed"></div>Stressed (50-79%)</div>
            <div class="legend-item"><div class="legend-dot degraded"></div>Degraded (25-49%)</div>
            <div class="legend-item"><div class="legend-dot critical"></div>Critical (0-24%)</div>
            <div class="divider"></div>
            <h3>Carriers</h3>
            <div class="legend-role"><div class="legend-role-dot" style="background:#fbbf24"></div>Role (stable)</div>
            <div class="legend-role"><div class="legend-role-dot" style="background:#f87171"></div>Role (at risk)</div>
        </div>
    </div>

    <script>
        // ============================================
        // DATA
        // ============================================
        const capacityNodes = [
            // MEANING
            { id: "nuance", label: "Nuance", cluster: "Meaning", health: 100,
              tooltip: "Meaning that rides between words.",
              degradeOutcome: "Communication becomes blunt, robotic. Subtlety disappears.",
              boostOutcome: "Interactions feel careful, considered. Trust increases.",
              roles: [
                { name: "Editors", atRisk: true },
                { name: "Diplomats", atRisk: false },
                { name: "Therapists", atRisk: false },
                { name: "Translators", atRisk: true },
                { name: "Poets", atRisk: true },
                { name: "Elders", atRisk: false }
              ]},
            { id: "subtext", label: "Subtext", cluster: "Meaning", health: 100,
              tooltip: "What's implied but not spoken.",
              degradeOutcome: "Everything becomes literal. Persuasion loses power.",
              boostOutcome: "Communication gains depth. Stories resonate.",
              roles: [
                { name: "Screenwriters", atRisk: true },
                { name: "Negotiators", atRisk: false },
                { name: "Satirists", atRisk: false },
                { name: "Bartenders", atRisk: false },
                { name: "Hairdressers", atRisk: false }
              ]},
            { id: "irony", label: "Irony", cluster: "Meaning", health: 100,
              tooltip: "Saying one thing while meaning another.",
              degradeOutcome: "Humor flattens. Cultural commentary disappears.",
              boostOutcome: "Discourse gains sophistication. Critique works.",
              roles: [
                { name: "Comedians", atRisk: false },
                { name: "Critics", atRisk: true },
                { name: "Literary Authors", atRisk: true },
                { name: "Cartoonists", atRisk: true }
              ]},
            { id: "hedging", label: "Hedging", cluster: "Meaning", health: 100,
              tooltip: "Soft certainty when reality is messy.",
              degradeOutcome: "Overconfidence everywhere. Liability increases.",
              boostOutcome: "Statements become trustworthy. Credibility rises.",
              roles: [
                { name: "Lawyers", atRisk: false },
                { name: "Scientists", atRisk: false },
                { name: "Risk Analysts", atRisk: false },
                { name: "Doctors", atRisk: false }
              ]},

            // PERSUASION
            { id: "framing", label: "Framing", cluster: "Persuasion", health: 100,
              tooltip: "The angle that changes interpretation.",
              degradeOutcome: "Arguments lose shape. Decisions stall.",
              boostOutcome: "Messages land. Action follows attention.",
              roles: [
                { name: "Journalists", atRisk: true },
                { name: "Politicians", atRisk: false },
                { name: "Marketers", atRisk: false },
                { name: "Activists", atRisk: false }
              ]},
            { id: "authority", label: "Authority", cluster: "Persuasion", health: 100,
              tooltip: "Signals that trigger deference.",
              degradeOutcome: "Leadership signals fail. Expertise ignored.",
              boostOutcome: "Direction followed. Coordination improves.",
              roles: [
                { name: "Executives", atRisk: false },
                { name: "Professors", atRisk: false },
                { name: "Surgeons", atRisk: false },
                { name: "Judges", atRisk: false }
              ]},
            { id: "socialproof", label: "Social Proof", cluster: "Persuasion", health: 100,
              tooltip: "'People like you do this.'",
              degradeOutcome: "Adoption stalls. Communities don't form.",
              boostOutcome: "Participation increases. Norms spread.",
              roles: [
                { name: "Marketers", atRisk: false },
                { name: "Influencers", atRisk: false },
                { name: "Community Organizers", atRisk: true },
                { name: "Neighbors", atRisk: false }
              ]},

            // SOCIAL
            { id: "trust", label: "Trust", cluster: "Social", health: 100,
              tooltip: "How humans decide 'safe, real, reliable.'",
              degradeOutcome: "CRITICAL. Adoption stops. Relationships break. Nothing scales.",
              boostOutcome: "Everything unlocks. Cooperation becomes possible.",
              roles: [
                { name: "Teachers", atRisk: true },
                { name: "Nurses", atRisk: true },
                { name: "Primary Care Doctors", atRisk: true },
                { name: "Clergy", atRisk: false },
                { name: "Parents", atRisk: false },
                { name: "Grandparents", atRisk: false },
                { name: "Corner Store Owners", atRisk: true },
                { name: "Librarians", atRisk: true }
              ]},
            { id: "politeness", label: "Politeness", cluster: "Social", health: 100,
              tooltip: "How we ask without demanding.",
              degradeOutcome: "Friction everywhere. Retention drops.",
              boostOutcome: "Friction decreases. Requests honored.",
              roles: [
                { name: "Hospitality Workers", atRisk: true },
                { name: "Customer Service", atRisk: true },
                { name: "Diplomats", atRisk: false },
                { name: "Flight Attendants", atRisk: false }
              ]},
            { id: "facesaving", label: "Face-Saving", cluster: "Social", health: 100,
              tooltip: "Protecting dignity in conversation.",
              degradeOutcome: "Conflicts escalate. Relationships rupture.",
              boostOutcome: "Exit ramps appear. Dignity preserved.",
              roles: [
                { name: "HR Professionals", atRisk: false },
                { name: "Mediators", atRisk: false },
                { name: "Managers", atRisk: false },
                { name: "Family Therapists", atRisk: false }
              ]},
            { id: "status", label: "Status", cluster: "Social", health: 100,
              tooltip: "Hierarchy signals in language.",
              degradeOutcome: "Coordination collapses. Authority vacuum.",
              boostOutcome: "Clear leadership. Roles understood.",
              roles: [
                { name: "Executives", atRisk: false },
                { name: "Military Officers", atRisk: false },
                { name: "Judges", atRisk: false }
              ]},

            // CULTURE
            { id: "belonging", label: "Belonging", cluster: "Culture", health: 100,
              tooltip: "Signals of 'us' and 'them.'",
              degradeOutcome: "Communities fragment. Loyalty disappears.",
              boostOutcome: "Groups cohere. Identity anchors.",
              roles: [
                { name: "Community Organizers", atRisk: true },
                { name: "Coaches", atRisk: false },
                { name: "Club Leaders", atRisk: false },
                { name: "Block Captains", atRisk: true },
                { name: "Union Reps", atRisk: true }
              ]},
            { id: "memegrammar", label: "Meme Grammar", cluster: "Culture", health: 100,
              tooltip: "The syntax of culture in motion.",
              degradeOutcome: "Content feels outdated. Relevance lost.",
              boostOutcome: "Content spreads. Engagement rises.",
              roles: [
                { name: "Social Media Managers", atRisk: false },
                { name: "Content Creators", atRisk: false },
                { name: "Youth Workers", atRisk: true },
                { name: "Teens", atRisk: false }
              ]},
            { id: "idioms", label: "Idioms", cluster: "Culture", health: 100,
              tooltip: "Compressed cultural memory.",
              degradeOutcome: "Speech feels foreign. Intelligence questioned.",
              boostOutcome: "Communication feels native. Understanding accelerates.",
              roles: [
                { name: "Translators", atRisk: true },
                { name: "Language Teachers", atRisk: true },
                { name: "Local Journalists", atRisk: true },
                { name: "Elders", atRisk: false },
                { name: "Grandparents", atRisk: false }
              ]},
            { id: "taboos", label: "Taboos", cluster: "Culture", health: 100,
              tooltip: "What not to say, and how we avoid it.",
              degradeOutcome: "Social backlash. PR crises. Boundaries violated.",
              boostOutcome: "Risk controlled. Limits maintained.",
              roles: [
                { name: "Editors", atRisk: true },
                { name: "PR Professionals", atRisk: false },
                { name: "Compliance Officers", atRisk: false },
                { name: "Elders", atRisk: false }
              ]},
            { id: "humor", label: "Humor", cluster: "Culture", health: 100,
              tooltip: "Bonding via surprise + timing.",
              degradeOutcome: "Bonding fails. Everything becomes tedious.",
              boostOutcome: "Connection happens. Messages stick.",
              roles: [
                { name: "Comedians", atRisk: false },
                { name: "Writers", atRisk: true },
                { name: "Camp Counselors", atRisk: false },
                { name: "Open Mic Hosts", atRisk: false }
              ]},
            { id: "freshness", label: "Freshness", cluster: "Culture", health: 100,
              tooltip: "Staying aligned with the moving present.",
              degradeOutcome: "Everything feels stale. The model feels 'old'.",
              boostOutcome: "Outputs feel current. Relevance maintained.",
              roles: [
                { name: "Trend Forecasters", atRisk: false },
                { name: "Journalists", atRisk: true },
                { name: "Youth Workers", atRisk: true },
                { name: "DJs", atRisk: false }
              ]},

            // EMOTION
            { id: "empathy", label: "Empathy", cluster: "Emotion", health: 100,
              tooltip: "Recognizing and responding to feelings.",
              degradeOutcome: "Help becomes hollow. 'Answering' replaces 'helping'.",
              boostOutcome: "Interactions heal. People feel seen.",
              roles: [
                { name: "Therapists", atRisk: false },
                { name: "Nurses", atRisk: true },
                { name: "Social Workers", atRisk: true },
                { name: "Caregivers", atRisk: true },
                { name: "Home Health Aides", atRisk: true },
                { name: "Hairdressers", atRisk: false },
                { name: "Bartenders", atRisk: false }
              ]},
            { id: "grief", label: "Grief Language", cluster: "Emotion", health: 100,
              tooltip: "How humans speak loss.",
              degradeOutcome: "Loss handled badly. Humans unseen in pain.",
              boostOutcome: "Loss honored. Hardest moments met with grace.",
              roles: [
                { name: "Hospice Workers", atRisk: true },
                { name: "Funeral Directors", atRisk: false },
                { name: "Chaplains", atRisk: false },
                { name: "Grief Counselors", atRisk: false },
                { name: "Neighbors", atRisk: false }
              ]},
            { id: "hope", label: "Hope", cluster: "Emotion", health: 100,
              tooltip: "Future-making in words.",
              degradeOutcome: "Motivation dies. Futures stop being built.",
              boostOutcome: "Action resumes. Possibility returns.",
              roles: [
                { name: "Coaches", atRisk: false },
                { name: "Teachers", atRisk: true },
                { name: "Activists", atRisk: false },
                { name: "Religious Leaders", atRisk: false },
                { name: "Parents", atRisk: false },
                { name: "Mentors", atRisk: false }
              ]},
            { id: "shame", label: "Shame", cluster: "Emotion", health: 100,
              tooltip: "Threat to belonging; triggers concealment.",
              degradeOutcome: "Ethics fails. Harmful behavior unchecked.",
              boostOutcome: "Boundaries hold. Accountability functions.",
              roles: [
                { name: "Therapists", atRisk: false },
                { name: "Ethicists", atRisk: false },
                { name: "Elders", atRisk: false },
                { name: "Parents", atRisk: false }
              ]},
            { id: "angercontrol", label: "De-escalation", cluster: "Emotion", health: 100,
              tooltip: "Reducing heat without surrender.",
              degradeOutcome: "Conflicts spiral. Polarization accelerates.",
              boostOutcome: "Heat reduces. Space for solutions appears.",
              roles: [
                { name: "Moderators", atRisk: true },
                { name: "Crisis Counselors", atRisk: false },
                { name: "Hostage Negotiators", atRisk: false },
                { name: "ER Nurses", atRisk: true },
                { name: "Teachers", atRisk: true },
                { name: "Bouncers", atRisk: false }
              ]},

            // JUDGMENT
            { id: "taste", label: "Taste", cluster: "Judgment", health: 100,
              tooltip: "Aesthetic judgment without explicit rules.",
              degradeOutcome: "Quality undetectable. Everything mediocre.",
              boostOutcome: "Quality emerges. 'Rightness' achieved.",
              roles: [
                { name: "Curators", atRisk: true },
                { name: "Editors", atRisk: true },
                { name: "Designers", atRisk: false },
                { name: "Art Directors", atRisk: false },
                { name: "Chefs", atRisk: false }
              ]},
            { id: "clarity", label: "Clarity", cluster: "Judgment", health: 100,
              tooltip: "Making meaning easy to grasp.",
              degradeOutcome: "Comprehension fails. Meaning drowns in noise.",
              boostOutcome: "Understanding improves. Signal cuts through.",
              roles: [
                { name: "Technical Writers", atRisk: true },
                { name: "Teachers", atRisk: true },
                { name: "Explainer Journalists", atRisk: true },
                { name: "UX Writers", atRisk: false }
              ]},
            { id: "timing", label: "Timing", cluster: "Judgment", health: 100,
              tooltip: "When to land the point.",
              degradeOutcome: "Impact lost. Humor fails. Points land wrong.",
              boostOutcome: "Impact maximized. Content becomes performance.",
              roles: [
                { name: "Comedians", atRisk: false },
                { name: "Directors", atRisk: false },
                { name: "Traders", atRisk: false },
                { name: "DJs", atRisk: false },
                { name: "Musicians", atRisk: false }
              ]},

            // COGNITION
            { id: "commonSense", label: "Common Sense", cluster: "Cognition", health: 100,
              tooltip: "Unspoken defaults about the world.",
              degradeOutcome: "Outputs feel alien. 'Weird AI' syndrome.",
              boostOutcome: "Outputs feel grounded. Normalcy achieved.",
              roles: [
                { name: "Parents", atRisk: false },
                { name: "Teachers", atRisk: true },
                { name: "Grandparents", atRisk: false },
                { name: "Farmers", atRisk: true },
                { name: "Tradespeople", atRisk: false }
              ]},
            { id: "analogy", label: "Analogy", cluster: "Cognition", health: 100,
              tooltip: "Mapping one domain onto another.",
              degradeOutcome: "Hard things stay hard. Learning stalls.",
              boostOutcome: "Complex becomes clear. Understanding transfers.",
              roles: [
                { name: "Teachers", atRisk: true },
                { name: "Science Communicators", atRisk: false },
                { name: "Coaches", atRisk: false },
                { name: "Writers", atRisk: true }
              ]},
            { id: "synthesis", label: "Synthesis", cluster: "Cognition", health: 100,
              tooltip: "Combining fragments into a coherent whole.",
              degradeOutcome: "Insight dies. Just fragments, no whole.",
              boostOutcome: "Insight emerges. Patterns revealed.",
              roles: [
                { name: "Researchers", atRisk: false },
                { name: "Analysts", atRisk: false },
                { name: "Investigative Journalists", atRisk: true },
                { name: "Consultants", atRisk: false },
                { name: "Detectives", atRisk: false }
              ]}
        ];

        const capacityLinks = [
            { source: "nuance", target: "hedging", type: "composed-of", weight: 0.7 },
            { source: "nuance", target: "politeness", type: "reinforces", weight: 0.5 },
            { source: "nuance", target: "trust", type: "reinforces", weight: 0.6 },
            { source: "subtext", target: "irony", type: "co-occurs", weight: 0.5 },
            { source: "subtext", target: "framing", type: "enables", weight: 0.6 },
            { source: "authority", target: "status", type: "co-occurs", weight: 0.5 },
            { source: "authority", target: "trust", type: "tensions", weight: -0.3 },
            { source: "socialproof", target: "belonging", type: "reinforces", weight: 0.6 },
            { source: "framing", target: "socialproof", type: "reinforces", weight: 0.5 },
            { source: "politeness", target: "facesaving", type: "reinforces", weight: 0.6 },
            { source: "facesaving", target: "angercontrol", type: "reinforces", weight: 0.5 },
            { source: "empathy", target: "trust", type: "reinforces", weight: 0.7 },
            { source: "empathy", target: "grief", type: "enables", weight: 0.8 },
            { source: "shame", target: "facesaving", type: "reinforces", weight: 0.5 },
            { source: "humor", target: "timing", type: "requires", weight: 0.8 },
            { source: "humor", target: "belonging", type: "reinforces", weight: 0.5 },
            { source: "memegrammar", target: "humor", type: "co-occurs", weight: 0.5 },
            { source: "idioms", target: "commonSense", type: "reinforces", weight: 0.4 },
            { source: "taboos", target: "facesaving", type: "drives", weight: 0.5 },
            { source: "freshness", target: "memegrammar", type: "feeds", weight: 0.6 },
            { source: "taste", target: "clarity", type: "balances", weight: 0.4 },
            { source: "clarity", target: "trust", type: "reinforces", weight: 0.6 },
            { source: "timing", target: "framing", type: "reinforces", weight: 0.5 },
            { source: "analogy", target: "synthesis", type: "reinforces", weight: 0.5 },
            { source: "commonSense", target: "trust", type: "supports", weight: 0.5 },
            { source: "synthesis", target: "clarity", type: "enables", weight: 0.6 },
            { source: "trust", target: "belonging", type: "reinforces", weight: 0.5 },
            { source: "trust", target: "hope", type: "enables", weight: 0.6 },
            { source: "empathy", target: "angercontrol", type: "reinforces", weight: 0.5 },
            { source: "clarity", target: "analogy", type: "reinforces", weight: 0.4 },
            { source: "taste", target: "nuance", type: "reinforces", weight: 0.5 },
            { source: "hope", target: "empathy", type: "reinforces", weight: 0.4 }
        ];

        // ============================================
        // SETUP
        // ============================================
        const clusterCenters = {
            'Meaning': { x: 0.15, y: 0.22 },
            'Persuasion': { x: 0.5, y: 0.1 },
            'Social': { x: 0.85, y: 0.22 },
            'Culture': { x: 0.12, y: 0.72 },
            'Emotion': { x: 0.5, y: 0.88 },
            'Judgment': { x: 0.88, y: 0.72 },
            'Cognition': { x: 0.5, y: 0.48 }
        };

        const clusterColors = {
            'Meaning': '#6366f1',
            'Persuasion': '#f59e0b',
            'Social': '#10b981',
            'Culture': '#ec4899',
            'Emotion': '#ef4444',
            'Judgment': '#8b5cf6',
            'Cognition': '#06b6d4'
        };

        const linkTypeLabels = {
            'reinforces': 'reinforces',
            'enables': 'enables',
            'tensions': 'tensions with',
            'composed-of': 'composed of',
            'co-occurs': 'co-occurs with',
            'requires': 'requires',
            'drives': 'drives',
            'feeds': 'feeds',
            'supports': 'supports',
            'balances': 'balances'
        };

        const width = window.innerWidth;
        const height = window.innerHeight;

        const svg = d3.select('#graph')
            .attr('width', width)
            .attr('height', height);

        const linkGroup = svg.append('g').attr('class', 'links');
        const roleLineGroup = svg.append('g').attr('class', 'role-lines');
        const roleLabelGroup = svg.append('g').attr('class', 'role-labels');
        const nodeGroup = svg.append('g').attr('class', 'nodes');

        capacityNodes.forEach(node => {
            const center = clusterCenters[node.cluster];
            node.x = center.x * width + (Math.random() - 0.5) * 60;
            node.y = center.y * height + (Math.random() - 0.5) * 60;
        });

        // ============================================
        // SIMULATION
        // ============================================
        const simulation = d3.forceSimulation(capacityNodes)
            .force('link', d3.forceLink(capacityLinks).id(d => d.id).distance(80).strength(0.3))
            .force('charge', d3.forceManyBody().strength(-250))
            .force('center', d3.forceCenter(width / 2, height / 2))
            .force('collision', d3.forceCollide().radius(40))
            .force('x', d3.forceX(d => clusterCenters[d.cluster].x * width).strength(0.08))
            .force('y', d3.forceY(d => clusterCenters[d.cluster].y * height).strength(0.08));

        // ============================================
        // DRAW LINKS
        // ============================================
        const linkElements = linkGroup.selectAll('line')
            .data(capacityLinks)
            .join('line')
            .attr('class', 'link-capacity')
            .attr('stroke-width', 1.5);

        // ============================================
        // DRAW NODES
        // ============================================
        const nodeElements = nodeGroup.selectAll('g')
            .data(capacityNodes)
            .join('g')
            .attr('class', 'node-capacity health-healthy')
            .call(d3.drag()
                .on('start', dragstarted)
                .on('drag', dragged)
                .on('end', dragended));

        nodeElements.append('circle')
            .attr('class', 'health-ring-bg')
            .attr('r', 26)
            .attr('fill', 'none')
            .attr('stroke', '#1e293b')
            .attr('stroke-width', 4);

        nodeElements.append('circle')
            .attr('class', 'health-ring')
            .attr('r', 26)
            .attr('stroke', '#22c55e')
            .attr('stroke-dasharray', '163 163')
            .attr('stroke-dashoffset', '0')
            .attr('transform', 'rotate(-90)');

        nodeElements.append('circle')
            .attr('class', 'main-circle')
            .attr('r', 20)
            .attr('fill', d => clusterColors[d.cluster]);

        nodeElements.append('text')
            .attr('class', 'node-label')
            .attr('dy', 36)
            .text(d => d.label);

        nodeElements.append('text')
            .attr('class', 'health-text')
            .attr('dy', 4)
            .text('100');

        // ============================================
        // STATE
        // ============================================
        let currentMode = 'view';
        let selectedNode = null;
        let draggingNode = null;
        let roleElements = { lines: [], labels: [], bgs: [] };

        // ============================================
        // MODE SWITCHING
        // ============================================
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentMode = btn.dataset.mode;
            });
        });

        // ============================================
        // RESET
        // ============================================
        document.getElementById('reset-btn').addEventListener('click', () => {
            capacityNodes.forEach(node => node.health = 100);
            updateAllVisuals();
            hideOutcomePanel();
            hideRoles();
            hideInfoPanel();
            hideDragPanel();
            linkElements.classed('cascade-active', false).classed('cascade-danger', false).classed('cascade-boost', false).classed('drag-highlight', false);
        });

        // ============================================
        // CLICK HANDLING
        // ============================================
        nodeElements.on('click', (event, d) => {
            event.stopPropagation();

            if (currentMode === 'view') {
                selectNode(d);
            } else {
                const delta = currentMode === 'degrade' ? -25 : 25;
                d.health = Math.max(0, Math.min(100, d.health + delta));
                const cascadeEffects = calculateCascade(d, delta);
                cascadeEffects.forEach(effect => {
                    const node = capacityNodes.find(n => n.id === effect.id);
                    if (node) node.health = Math.max(0, Math.min(100, node.health + effect.delta));
                });
                updateAllVisuals();
                showOutcome(d, cascadeEffects, currentMode);
                highlightCascadeLinks(d, cascadeEffects, currentMode);
                selectNode(d);
            }
        });

        svg.on('click', () => {
            hideRoles();
            hideInfoPanel();
            hideOutcomePanel();
            hideDragPanel();
            nodeElements.classed('selected', false);
            selectedNode = null;
            linkElements.classed('cascade-active', false).classed('cascade-danger', false).classed('cascade-boost', false).classed('drag-highlight', false);
        });

        // ============================================
        // NODE SELECTION & ROLES
        // ============================================
        function selectNode(d) {
            hideRoles();
            selectedNode = d;
            nodeElements.classed('selected', n => n.id === d.id);
            showInfoPanel(d);
            showRoles(d);
        }

        function showRoles(capacity) {
            const roles = capacity.roles;
            const numRoles = roles.length;
            const baseRadius = 90;

            roles.forEach((role, i) => {
                const angle = (i / numRoles) * Math.PI * 2 - Math.PI / 2;
                const radius = baseRadius + (i % 2) * 20;
                const x = capacity.x + Math.cos(angle) * radius;
                const y = capacity.y + Math.sin(angle) * radius;

                const line = roleLineGroup.append('line')
                    .attr('class', 'role-line')
                    .attr('x1', capacity.x)
                    .attr('y1', capacity.y)
                    .attr('x2', x)
                    .attr('y2', y);

                const textWidth = role.name.length * 6 + 12;
                const bg = roleLabelGroup.append('rect')
                    .attr('class', 'role-label-bg')
                    .attr('x', x - textWidth / 2)
                    .attr('y', y - 8)
                    .attr('width', textWidth)
                    .attr('height', 16)
                    .attr('rx', 8);

                const label = roleLabelGroup.append('text')
                    .attr('class', `role-label ${role.atRisk ? 'at-risk' : ''}`)
                    .attr('x', x)
                    .attr('y', y + 3)
                    .text(role.name);

                roleElements.lines.push(line);
                roleElements.bgs.push(bg);
                roleElements.labels.push(label);

                setTimeout(() => {
                    line.classed('visible', true);
                    bg.classed('visible', true);
                    label.classed('visible', true);
                }, i * 40);
            });
        }

        function hideRoles() {
            roleElements.lines.forEach(el => el.remove());
            roleElements.labels.forEach(el => el.remove());
            roleElements.bgs.forEach(el => el.remove());
            roleElements = { lines: [], labels: [], bgs: [] };
        }

        function updateRolePositions() {
            if (!selectedNode) return;
            const capacity = selectedNode;
            const roles = capacity.roles;
            const numRoles = roles.length;
            const baseRadius = 90;

            roles.forEach((role, i) => {
                const angle = (i / numRoles) * Math.PI * 2 - Math.PI / 2;
                const radius = baseRadius + (i % 2) * 20;
                const x = capacity.x + Math.cos(angle) * radius;
                const y = capacity.y + Math.sin(angle) * radius;
                const textWidth = role.name.length * 6 + 12;

                if (roleElements.lines[i]) {
                    roleElements.lines[i].attr('x1', capacity.x).attr('y1', capacity.y).attr('x2', x).attr('y2', y);
                    roleElements.bgs[i].attr('x', x - textWidth / 2).attr('y', y - 8);
                    roleElements.labels[i].attr('x', x).attr('y', y + 3);
                }
            });
        }

        // ============================================
        // INFO PANEL
        // ============================================
        function showInfoPanel(d) {
            document.getElementById('node-title').textContent = d.label;
            const badge = document.getElementById('cluster-badge');
            badge.textContent = d.cluster;
            badge.style.background = clusterColors[d.cluster];
            document.getElementById('node-tooltip').textContent = d.tooltip;

            const rolesList = document.getElementById('roles-list');
            rolesList.innerHTML = '';
            d.roles.forEach(role => {
                const span = document.createElement('span');
                span.className = `role-tag ${role.atRisk ? 'at-risk' : ''}`;
                span.textContent = role.name;
                rolesList.appendChild(span);
            });

            document.getElementById('info-panel').classList.add('visible');
        }

        function hideInfoPanel() {
            document.getElementById('info-panel').classList.remove('visible');
        }

        // ============================================
        // DRAG PANEL - NEW
        // ============================================
        function showDragPanel(d) {
            draggingNode = d;
            const panel = document.getElementById('drag-panel');

            // Node name
            document.getElementById('drag-node-name').textContent = d.label;

            // Find all connected nodes
            const connections = getConnections(d);
            const depList = document.getElementById('dependency-list');
            depList.innerHTML = '';

            connections.forEach(conn => {
                const item = document.createElement('div');
                item.className = 'dependency-item';
                item.innerHTML = `
                    <span class="dep-name">${conn.node.label}</span>
                    <span class="dep-type ${conn.type}">${linkTypeLabels[conn.type] || conn.type}</span>
                `;
                depList.appendChild(item);
            });

            // Calculate predicted cascade
            const predictedCascade = calculateCascade(d, -25);
            const cascadePreview = document.getElementById('cascade-preview');
            const cascadeEffects = document.getElementById('cascade-effects');
            cascadeEffects.innerHTML = '';

            if (predictedCascade.length > 0) {
                predictedCascade.slice(0, 8).forEach(effect => {
                    const span = document.createElement('span');
                    span.className = `cascade-effect ${effect.delta > 0 ? 'positive' : ''}`;
                    const nodeName = capacityNodes.find(n => n.id === effect.id)?.label || effect.id;
                    span.textContent = `${nodeName} ${effect.delta > 0 ? '+' : ''}${effect.delta}%`;
                    cascadeEffects.appendChild(span);
                });
            } else {
                cascadeEffects.innerHTML = '<span style="color:#64748b;font-size:10px;">Minimal cascade</span>';
            }

            // Calculate system impact
            const totalImpact = predictedCascade.reduce((sum, e) => sum + e.delta, 0) - 25;
            const avgImpact = totalImpact / capacityNodes.length;
            const impactValue = document.getElementById('impact-value');
            impactValue.textContent = `${avgImpact > 0 ? '+' : ''}${avgImpact.toFixed(1)}%`;
            impactValue.className = `impact-value ${avgImpact > 0 ? 'positive' : ''}`;

            panel.classList.add('visible');
        }

        function hideDragPanel() {
            document.getElementById('drag-panel').classList.remove('visible');
            draggingNode = null;
        }

        function getConnections(node) {
            const connections = [];
            capacityLinks.forEach(link => {
                const sourceId = link.source.id || link.source;
                const targetId = link.target.id || link.target;

                if (sourceId === node.id) {
                    const targetNode = capacityNodes.find(n => n.id === targetId);
                    if (targetNode) connections.push({ node: targetNode, type: link.type, direction: 'out' });
                } else if (targetId === node.id) {
                    const sourceNode = capacityNodes.find(n => n.id === sourceId);
                    if (sourceNode) connections.push({ node: sourceNode, type: link.type, direction: 'in' });
                }
            });
            return connections;
        }

        // ============================================
        // CASCADE LOGIC
        // ============================================
        function calculateCascade(sourceNode, sourceDelta) {
            const effects = [];
            const visited = new Set([sourceNode.id]);

            function propagate(nodeId, delta, depth) {
                if (depth > 3) return;

                capacityLinks.forEach(link => {
                    let targetId = null;
                    let weight = Math.abs(link.weight);

                    if ((link.source.id || link.source) === nodeId) {
                        targetId = link.target.id || link.target;
                    } else if ((link.target.id || link.target) === nodeId) {
                        targetId = link.source.id || link.source;
                    }

                    if (!targetId || visited.has(targetId)) return;

                    let effectDelta = 0;
                    if (link.type === 'tensions') {
                        effectDelta = -delta * weight * 0.4;
                    } else if (link.type === 'enables' || link.type === 'requires') {
                        effectDelta = delta * weight * 0.6;
                    } else if (link.type === 'reinforces' || link.type === 'supports') {
                        effectDelta = delta * weight * 0.5;
                    } else {
                        effectDelta = delta * weight * 0.3;
                    }

                    effectDelta = effectDelta * (1 - depth * 0.25);

                    if (Math.abs(effectDelta) >= 3) {
                        visited.add(targetId);
                        effects.push({ id: targetId, delta: Math.round(effectDelta), fromLink: link.type });
                        propagate(targetId, effectDelta, depth + 1);
                    }
                });
            }

            propagate(sourceNode.id, sourceDelta, 0);
            return effects;
        }

        // ============================================
        // VISUAL UPDATES
        // ============================================
        function updateAllVisuals() {
            nodeElements.each(function(d) {
                const group = d3.select(this);
                const health = d.health;

                let classStr = `node-capacity health-${getHealthState(health)}`;
                if (selectedNode && selectedNode.id === d.id) classStr += ' selected';
                if (draggingNode && draggingNode.id === d.id) classStr += ' dragging';
                group.attr('class', classStr);

                const circumference = 163;
                const dashoffset = circumference * (1 - health / 100);
                group.select('.health-ring')
                    .attr('stroke-dashoffset', dashoffset)
                    .attr('stroke', getHealthColor(health));

                group.select('.health-text').text(Math.round(health));
            });

            updateSystemHealth();
        }

        function getHealthState(health) {
            if (health >= 80) return 'healthy';
            if (health >= 50) return 'stressed';
            if (health >= 25) return 'degraded';
            return 'critical';
        }

        function getHealthColor(health) {
            if (health >= 80) return '#22c55e';
            if (health >= 50) return '#fbbf24';
            if (health >= 25) return '#f97316';
            return '#ef4444';
        }

        function updateSystemHealth() {
            const avgHealth = capacityNodes.reduce((sum, n) => sum + n.health, 0) / capacityNodes.length;
            document.getElementById('health-fill').style.width = `${avgHealth}%`;
            document.getElementById('health-fill').style.background = getHealthColor(avgHealth);
            document.getElementById('health-value').textContent = `${Math.round(avgHealth)}%`;
            document.getElementById('health-value').style.color = getHealthColor(avgHealth);
        }

        // ============================================
        // OUTCOME PANEL
        // ============================================
        function showOutcome(node, cascadeEffects, mode) {
            const panel = document.getElementById('outcome-panel');
            const isDegrading = mode === 'degrade';

            document.getElementById('outcome-title').textContent = `${node.label} ${isDegrading ? 'Degraded' : 'Boosted'}`;
            document.getElementById('outcome-text').textContent = isDegrading ? node.degradeOutcome : node.boostOutcome;
            panel.querySelector('.status-dot').style.background = isDegrading ? '#ef4444' : '#22c55e';

            const cascadeItems = document.getElementById('cascade-items');
            cascadeItems.innerHTML = '';
            if (cascadeEffects.length > 0) {
                cascadeEffects.forEach(effect => {
                    const span = document.createElement('span');
                    span.className = `cascade-item ${effect.delta > 0 ? 'boost' : ''}`;
                    const nodeName = capacityNodes.find(n => n.id === effect.id)?.label || effect.id;
                    span.textContent = `${nodeName} ${effect.delta > 0 ? '+' : ''}${effect.delta}%`;
                    cascadeItems.appendChild(span);
                });
            } else {
                cascadeItems.innerHTML = '<span style="color:#64748b">No cascade</span>';
            }

            panel.classList.add('visible');
        }

        function hideOutcomePanel() {
            document.getElementById('outcome-panel').classList.remove('visible');
        }

        // ============================================
        // CASCADE LINK HIGHLIGHTING
        // ============================================
        function highlightCascadeLinks(sourceNode, cascadeEffects, mode) {
            linkElements.classed('cascade-active', false).classed('cascade-danger', false).classed('cascade-boost', false);
            const affectedIds = new Set([sourceNode.id, ...cascadeEffects.map(e => e.id)]);

            linkElements.each(function(d) {
                const sourceId = d.source.id || d.source;
                const targetId = d.target.id || d.target;
                if (affectedIds.has(sourceId) && affectedIds.has(targetId)) {
                    d3.select(this).classed(mode === 'degrade' ? 'cascade-danger' : 'cascade-boost', true);
                }
            });
        }

        function highlightDragLinks(node) {
            const connectedIds = new Set([node.id]);
            capacityLinks.forEach(link => {
                const sourceId = link.source.id || link.source;
                const targetId = link.target.id || link.target;
                if (sourceId === node.id) connectedIds.add(targetId);
                if (targetId === node.id) connectedIds.add(sourceId);
            });

            linkElements.classed('drag-highlight', d => {
                const sourceId = d.source.id || d.source;
                const targetId = d.target.id || d.target;
                return sourceId === node.id || targetId === node.id;
            });

            nodeElements.classed('connected-drag', n => connectedIds.has(n.id) && n.id !== node.id);
            nodeElements.classed('faded-drag', n => !connectedIds.has(n.id));
        }

        function clearDragHighlights() {
            linkElements.classed('drag-highlight', false);
            nodeElements.classed('connected-drag', false);
            nodeElements.classed('faded-drag', false);
            nodeElements.classed('dragging', false);
        }

        // ============================================
        // SIMULATION TICK
        // ============================================
        simulation.on('tick', () => {
            linkElements
                .attr('x1', d => d.source.x)
                .attr('y1', d => d.source.y)
                .attr('x2', d => d.target.x)
                .attr('y2', d => d.target.y);

            nodeElements.attr('transform', d => `translate(${d.x},${d.y})`);

            if (selectedNode) updateRolePositions();
        });

        // ============================================
        // DRAG - ENHANCED
        // ============================================
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;

            // Show drag panel and highlights
            nodeElements.classed('dragging', n => n.id === d.id);
            highlightDragLinks(d);
            showDragPanel(d);
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;

            clearDragHighlights();
            hideDragPanel();

            // Restore selection state if exists
            if (selectedNode) {
                nodeElements.classed('selected', n => n.id === selectedNode.id);
            }
        }

        // ============================================
        // RESIZE
        // ============================================
        window.addEventListener('resize', () => {
            const newWidth = window.innerWidth;
            const newHeight = window.innerHeight;
            svg.attr('width', newWidth).attr('height', newHeight);
            simulation.force('center', d3.forceCenter(newWidth / 2, newHeight / 2));
            simulation.alpha(0.3).restart();
        });

        updateAllVisuals();
    </script>
</body>
</html>
