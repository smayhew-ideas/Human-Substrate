<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Human Substrate</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0f;
            color: #e8e8e8;
            overflow: hidden;
            touch-action: none;
        }

        #container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        svg {
            width: 100%;
            height: 100%;
        }

        /* Links */
        .link-capacity {
            stroke: #334155;
            stroke-opacity: 0.25;
            fill: none;
            transition: stroke 0.3s ease, stroke-opacity 0.3s ease;
        }

        .link-capacity.cascade-danger { stroke-opacity: 0.9; stroke: #ef4444; }
        .link-capacity.cascade-boost { stroke-opacity: 0.9; stroke: #22c55e; }
        .link-capacity.drag-highlight { stroke-opacity: 0.9; stroke: #fbbf24; stroke-width: 2.5px; }

        /* Role lines & labels */
        .role-line {
            stroke: #fbbf24;
            stroke-width: 1.5;
            stroke-dasharray: 4, 4;
            stroke-opacity: 0;
            fill: none;
            transition: stroke-opacity 0.3s ease;
            pointer-events: none;
        }
        .role-line.visible { stroke-opacity: 0.5; }

        .role-label-bg {
            fill: rgba(10, 10, 15, 0.9);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .role-label-bg.visible { opacity: 1; }

        .role-label {
            font-size: 10px;
            font-weight: 500;
            fill: #fbbf24;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            text-anchor: middle;
        }
        .role-label.visible { opacity: 1; }
        .role-label.at-risk { fill: #f87171; }

        /* Nodes */
        .node-capacity {
            cursor: pointer;
        }

        .node-capacity circle.main-circle {
            stroke-width: 3px;
            transition: all 0.4s ease;
        }

        .node-capacity text.node-label {
            font-size: 9px;
            font-weight: 500;
            fill: #e2e8f0;
            pointer-events: none;
            text-anchor: middle;
        }

        .node-capacity .health-ring {
            fill: none;
            stroke-width: 4px;
            transition: stroke-dasharray 0.5s ease, stroke 0.5s ease;
        }

        .node-capacity .health-text {
            font-size: 8px;
            fill: #94a3b8;
            text-anchor: middle;
            font-weight: 600;
        }

        .health-healthy .main-circle { stroke: rgba(34, 197, 94, 0.7); }
        .health-stressed .main-circle { stroke: rgba(251, 191, 36, 0.8); }
        .health-degraded .main-circle { stroke: rgba(249, 115, 22, 0.9); }
        .health-critical .main-circle { stroke: rgba(239, 68, 68, 1); animation: pulse-critical 1.2s ease-in-out infinite; }

        @keyframes pulse-critical {
            0%, 100% { filter: drop-shadow(0 0 6px rgba(239, 68, 68, 0.5)); }
            50% { filter: drop-shadow(0 0 14px rgba(239, 68, 68, 0.8)); }
        }

        .node-capacity.selected .main-circle,
        .node-capacity.dragging .main-circle {
            stroke: #fbbf24 !important;
            stroke-width: 4px;
            filter: drop-shadow(0 0 10px rgba(251, 191, 36, 0.5));
        }

        .node-capacity.connected-drag .main-circle {
            stroke: rgba(251, 191, 36, 0.7) !important;
        }

        .node-capacity.faded-drag { opacity: 0.3; }

        /* Header */
        #header {
            position: absolute;
            top: 12px;
            left: 12px;
            z-index: 10;
        }

        #header h1 {
            font-size: 16px;
            font-weight: 600;
            color: #f1f5f9;
        }

        #header p {
            font-size: 10px;
            color: #64748b;
        }

        /* Control Panel */
        #controls {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid #334155;
            border-radius: 10px;
            padding: 12px;
            width: 180px;
            backdrop-filter: blur(8px);
            z-index: 20;
        }

        #controls h3 {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #64748b;
            margin-bottom: 8px;
        }

        .mode-buttons {
            display: flex;
            gap: 4px;
            margin-bottom: 10px;
        }

        .mode-btn {
            flex: 1;
            padding: 8px 4px;
            border: 1px solid #334155;
            border-radius: 6px;
            background: #1e293b;
            color: #94a3b8;
            font-size: 10px;
            font-weight: 500;
            cursor: pointer;
        }

        .mode-btn.active { color: white; }
        .mode-btn.degrade.active { background: #dc2626; border-color: #dc2626; }
        .mode-btn.boost.active { background: #16a34a; border-color: #16a34a; }
        .mode-btn.view.active { background: #2563eb; border-color: #2563eb; }

        #reset-btn {
            width: 100%;
            padding: 6px;
            border: 1px solid #475569;
            border-radius: 6px;
            background: transparent;
            color: #94a3b8;
            font-size: 10px;
            cursor: pointer;
        }

        #system-health {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #334155;
        }

        #system-health .label {
            font-size: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #64748b;
            margin-bottom: 4px;
        }

        #health-bar {
            height: 5px;
            background: #1e293b;
            border-radius: 3px;
            overflow: hidden;
        }

        #health-fill {
            height: 100%;
            background: #22c55e;
            border-radius: 3px;
            transition: width 0.5s ease, background 0.5s ease;
        }

        #health-value {
            font-size: 16px;
            font-weight: 600;
            color: #22c55e;
            margin-top: 4px;
        }

        /* PANELS - Responsive Container */
        #panels-container {
            position: absolute;
            bottom: 12px;
            left: 12px;
            right: 12px;
            display: flex;
            gap: 10px;
            max-height: 35vh;
            z-index: 15;
            pointer-events: none;
        }

        #panels-container > div {
            pointer-events: auto;
        }

        /* Drag Panel */
        #drag-panel {
            flex: 0 0 280px;
            background: rgba(30, 41, 59, 0.97);
            border: 1px solid #fbbf24;
            border-radius: 10px;
            padding: 12px;
            backdrop-filter: blur(10px);
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.25s ease;
            overflow-y: auto;
            max-height: 100%;
        }

        #drag-panel.visible {
            opacity: 1;
            transform: translateY(0);
        }

        #drag-panel h3 {
            font-size: 13px;
            font-weight: 600;
            color: #fbbf24;
            margin-bottom: 2px;
        }

        #drag-panel .subtitle {
            font-size: 9px;
            color: #64748b;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        #drag-panel .section {
            margin-bottom: 10px;
        }

        #drag-panel .section-title {
            font-size: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #64748b;
            margin-bottom: 6px;
        }

        #drag-panel .dependency-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
            max-height: 80px;
            overflow-y: auto;
        }

        #drag-panel .dependency-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 4px 8px;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 4px;
            font-size: 10px;
        }

        #drag-panel .dep-name { color: #e2e8f0; font-weight: 500; }
        #drag-panel .dep-type {
            color: #94a3b8;
            font-size: 9px;
            padding: 2px 5px;
            background: rgba(71, 85, 105, 0.5);
            border-radius: 3px;
        }

        #drag-panel .dep-type.reinforces { background: rgba(59, 130, 246, 0.3); color: #93c5fd; }
        #drag-panel .dep-type.enables { background: rgba(34, 197, 94, 0.3); color: #86efac; }
        #drag-panel .dep-type.tensions { background: rgba(239, 68, 68, 0.3); color: #fca5a5; }

        #drag-panel .cascade-preview {
            padding: 8px 10px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 6px;
        }

        #drag-panel .cascade-title {
            font-size: 9px;
            color: #f87171;
            font-weight: 600;
            margin-bottom: 4px;
        }

        #drag-panel .cascade-effects {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
        }

        #drag-panel .cascade-effect {
            font-size: 9px;
            padding: 2px 5px;
            background: rgba(239, 68, 68, 0.2);
            border-radius: 3px;
            color: #fca5a5;
        }

        #drag-panel .cascade-effect.positive {
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
        }

        #drag-panel .impact-stat {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #334155;
        }

        #drag-panel .impact-label { font-size: 9px; color: #94a3b8; }
        #drag-panel .impact-value { font-size: 14px; font-weight: 600; color: #f87171; }
        #drag-panel .impact-value.positive { color: #4ade80; }

        /* Info Panel */
        #info-panel {
            flex: 0 0 200px;
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid #334155;
            border-radius: 10px;
            padding: 12px;
            backdrop-filter: blur(8px);
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            overflow-y: auto;
            max-height: 100%;
        }

        #info-panel.visible {
            opacity: 1;
            transform: translateY(0);
        }

        #info-panel h2 {
            font-size: 13px;
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 2px;
        }

        #info-panel .cluster-badge {
            display: inline-block;
            font-size: 8px;
            font-weight: 500;
            padding: 2px 6px;
            border-radius: 6px;
            margin-bottom: 8px;
            color: white;
        }

        #info-panel .tooltip {
            font-size: 11px;
            color: #94a3b8;
            line-height: 1.4;
            margin-bottom: 8px;
            font-style: italic;
        }

        #info-panel .section-title {
            font-size: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #64748b;
            margin-bottom: 6px;
        }

        #info-panel .roles-list {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
        }

        #info-panel .role-tag {
            font-size: 9px;
            padding: 2px 6px;
            background: #fbbf24;
            border-radius: 3px;
            color: #0a0a0f;
            font-weight: 500;
        }

        #info-panel .role-tag.at-risk {
            background: #f87171;
            color: white;
        }

        /* Outcome Panel */
        #outcome-panel {
            flex: 1;
            min-width: 0;
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid #334155;
            border-radius: 10px;
            padding: 12px;
            backdrop-filter: blur(8px);
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            overflow-y: auto;
            max-height: 100%;
        }

        #outcome-panel.visible {
            opacity: 1;
            transform: translateY(0);
        }

        #outcome-panel h3 {
            font-size: 12px;
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        #outcome-panel .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        #outcome-panel p {
            font-size: 11px;
            color: #cbd5e1;
            line-height: 1.4;
            margin-bottom: 8px;
        }

        #outcome-panel .cascade-list {
            font-size: 10px;
            color: #94a3b8;
        }

        #outcome-panel .cascade-item {
            display: inline-block;
            padding: 2px 5px;
            background: rgba(239, 68, 68, 0.2);
            border-radius: 3px;
            margin: 2px 2px 2px 0;
            color: #fca5a5;
            font-size: 9px;
        }

        #outcome-panel .cascade-item.boost {
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
        }

        /* Legend - moved to top left under header */
        #legend {
            position: absolute;
            top: 70px;
            left: 12px;
            background: rgba(30, 41, 59, 0.85);
            border: 1px solid #334155;
            padding: 8px 12px;
            border-radius: 8px;
            backdrop-filter: blur(8px);
            z-index: 10;
        }

        #legend h3 {
            font-size: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #64748b;
            margin-bottom: 6px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 9px;
            color: #94a3b8;
            margin-bottom: 2px;
        }

        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            border: 2px solid;
            background: transparent;
        }

        .legend-dot.healthy { border-color: #22c55e; }
        .legend-dot.stressed { border-color: #fbbf24; }
        .legend-dot.degraded { border-color: #f97316; }
        .legend-dot.critical { border-color: #ef4444; }

        /* iPad & Tablet Adjustments */
        @media (max-width: 1024px) {
            #controls {
                width: 160px;
                padding: 10px;
            }

            #panels-container {
                flex-direction: column;
                max-height: 40vh;
            }

            #drag-panel,
            #info-panel,
            #outcome-panel {
                flex: none;
                width: 100%;
                max-height: none;
            }

            #drag-panel .dependency-list {
                max-height: 60px;
            }

            #legend {
                top: auto;
                bottom: auto;
                top: 60px;
            }
        }

        /* Phone */
        @media (max-width: 600px) {
            #header h1 { font-size: 14px; }
            #header p { font-size: 9px; }

            #controls {
                width: 140px;
                padding: 8px;
            }

            .mode-btn {
                padding: 6px 2px;
                font-size: 9px;
            }

            #panels-container {
                max-height: 35vh;
            }

            #legend {
                display: none;
            }

            .node-capacity text.node-label {
                font-size: 8px;
            }
        }
    </style>
</head>
<body>
    <div id="container">
        <svg id="graph"></svg>

        <div id="header">
            <h1>The Human Substrate</h1>
            <p>Capacities, Carriers, Cascades</p>
        </div>

        <div id="controls">
            <h3>Intervention</h3>
            <div class="mode-buttons">
                <button class="mode-btn view active" data-mode="view">View</button>
                <button class="mode-btn degrade" data-mode="degrade">Degrade</button>
                <button class="mode-btn boost" data-mode="boost">Boost</button>
            </div>
            <button id="reset-btn">Reset System</button>
            <div id="system-health">
                <div class="label">System Health</div>
                <div id="health-bar"><div id="health-fill" style="width: 100%"></div></div>
                <div id="health-value">100%</div>
            </div>
        </div>

        <div id="legend">
            <h3>Health</h3>
            <div class="legend-item"><div class="legend-dot healthy"></div>Healthy</div>
            <div class="legend-item"><div class="legend-dot stressed"></div>Stressed</div>
            <div class="legend-item"><div class="legend-dot degraded"></div>Degraded</div>
            <div class="legend-item"><div class="legend-dot critical"></div>Critical</div>
        </div>

        <div id="panels-container">
            <div id="drag-panel">
                <h3><span id="drag-node-name">Node</span></h3>
                <div class="subtitle">Dependencies & Impact</div>
                <div class="section">
                    <div class="section-title">Connected To</div>
                    <div id="dependency-list" class="dependency-list"></div>
                </div>
                <div class="section">
                    <div id="cascade-preview" class="cascade-preview">
                        <div class="cascade-title">If Degraded:</div>
                        <div id="cascade-effects" class="cascade-effects"></div>
                    </div>
                </div>
                <div class="impact-stat">
                    <span class="impact-label">System Impact</span>
                    <span id="impact-value" class="impact-value">-0%</span>
                </div>
            </div>

            <div id="info-panel">
                <h2 id="node-title"></h2>
                <span id="cluster-badge" class="cluster-badge"></span>
                <p id="node-tooltip" class="tooltip"></p>
                <div class="section-title">Carried By</div>
                <div id="roles-list" class="roles-list"></div>
            </div>

            <div id="outcome-panel">
                <h3><span class="status-dot"></span><span id="outcome-title"></span></h3>
                <p id="outcome-text"></p>
                <div class="cascade-list">
                    <strong>Cascade:</strong>
                    <span id="cascade-items"></span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // DATA
        // ============================================
        const capacityNodes = [
            { id: "nuance", label: "Nuance", cluster: "Meaning", health: 100,
              tooltip: "Meaning that rides between words.",
              degradeOutcome: "Communication becomes blunt, robotic. Subtlety disappears.",
              boostOutcome: "Interactions feel careful, considered. Trust increases.",
              roles: [
                { name: "Editors", atRisk: true },
                { name: "Diplomats", atRisk: false },
                { name: "Therapists", atRisk: false },
                { name: "Translators", atRisk: true },
                { name: "Elders", atRisk: false }
              ]},
            { id: "subtext", label: "Subtext", cluster: "Meaning", health: 100,
              tooltip: "What's implied but not spoken.",
              degradeOutcome: "Everything becomes literal. Persuasion loses power.",
              boostOutcome: "Communication gains depth. Stories resonate.",
              roles: [
                { name: "Screenwriters", atRisk: true },
                { name: "Negotiators", atRisk: false },
                { name: "Bartenders", atRisk: false },
                { name: "Hairdressers", atRisk: false }
              ]},
            { id: "irony", label: "Irony", cluster: "Meaning", health: 100,
              tooltip: "Saying one thing while meaning another.",
              degradeOutcome: "Humor flattens. Cultural commentary disappears.",
              boostOutcome: "Discourse gains sophistication.",
              roles: [
                { name: "Comedians", atRisk: false },
                { name: "Critics", atRisk: true },
                { name: "Cartoonists", atRisk: true }
              ]},
            { id: "hedging", label: "Hedging", cluster: "Meaning", health: 100,
              tooltip: "Soft certainty when reality is messy.",
              degradeOutcome: "Overconfidence everywhere. Liability increases.",
              boostOutcome: "Statements become trustworthy.",
              roles: [
                { name: "Lawyers", atRisk: false },
                { name: "Scientists", atRisk: false },
                { name: "Doctors", atRisk: false }
              ]},
            { id: "framing", label: "Framing", cluster: "Persuasion", health: 100,
              tooltip: "The angle that changes interpretation.",
              degradeOutcome: "Arguments lose shape. Decisions stall.",
              boostOutcome: "Messages land. Action follows.",
              roles: [
                { name: "Journalists", atRisk: true },
                { name: "Politicians", atRisk: false },
                { name: "Marketers", atRisk: false }
              ]},
            { id: "authority", label: "Authority", cluster: "Persuasion", health: 100,
              tooltip: "Signals that trigger deference.",
              degradeOutcome: "Leadership signals fail. Expertise ignored.",
              boostOutcome: "Direction followed. Coordination improves.",
              roles: [
                { name: "Executives", atRisk: false },
                { name: "Professors", atRisk: false },
                { name: "Judges", atRisk: false }
              ]},
            { id: "socialproof", label: "Social Proof", cluster: "Persuasion", health: 100,
              tooltip: "'People like you do this.'",
              degradeOutcome: "Adoption stalls. Communities don't form.",
              boostOutcome: "Participation increases. Norms spread.",
              roles: [
                { name: "Marketers", atRisk: false },
                { name: "Influencers", atRisk: false },
                { name: "Neighbors", atRisk: false }
              ]},
            { id: "trust", label: "Trust", cluster: "Social", health: 100,
              tooltip: "How humans decide 'safe, real, reliable.'",
              degradeOutcome: "CRITICAL. Adoption stops. Nothing scales.",
              boostOutcome: "Everything unlocks. Cooperation possible.",
              roles: [
                { name: "Teachers", atRisk: true },
                { name: "Nurses", atRisk: true },
                { name: "Parents", atRisk: false },
                { name: "Grandparents", atRisk: false },
                { name: "Librarians", atRisk: true }
              ]},
            { id: "politeness", label: "Politeness", cluster: "Social", health: 100,
              tooltip: "How we ask without demanding.",
              degradeOutcome: "Friction everywhere. Retention drops.",
              boostOutcome: "Friction decreases. Requests honored.",
              roles: [
                { name: "Hospitality Workers", atRisk: true },
                { name: "Customer Service", atRisk: true },
                { name: "Diplomats", atRisk: false }
              ]},
            { id: "facesaving", label: "Face-Saving", cluster: "Social", health: 100,
              tooltip: "Protecting dignity in conversation.",
              degradeOutcome: "Conflicts escalate. Relationships rupture.",
              boostOutcome: "Exit ramps appear. Dignity preserved.",
              roles: [
                { name: "HR Professionals", atRisk: false },
                { name: "Mediators", atRisk: false },
                { name: "Family Therapists", atRisk: false }
              ]},
            { id: "status", label: "Status", cluster: "Social", health: 100,
              tooltip: "Hierarchy signals in language.",
              degradeOutcome: "Coordination collapses. Authority vacuum.",
              boostOutcome: "Clear leadership. Roles understood.",
              roles: [
                { name: "Executives", atRisk: false },
                { name: "Military Officers", atRisk: false },
                { name: "Judges", atRisk: false }
              ]},
            { id: "belonging", label: "Belonging", cluster: "Culture", health: 100,
              tooltip: "Signals of 'us' and 'them.'",
              degradeOutcome: "Communities fragment. Loyalty disappears.",
              boostOutcome: "Groups cohere. Identity anchors.",
              roles: [
                { name: "Community Organizers", atRisk: true },
                { name: "Coaches", atRisk: false },
                { name: "Union Reps", atRisk: true }
              ]},
            { id: "memegrammar", label: "Meme Grammar", cluster: "Culture", health: 100,
              tooltip: "The syntax of culture in motion.",
              degradeOutcome: "Content feels outdated. Relevance lost.",
              boostOutcome: "Content spreads. Engagement rises.",
              roles: [
                { name: "Content Creators", atRisk: false },
                { name: "Youth Workers", atRisk: true },
                { name: "Teens", atRisk: false }
              ]},
            { id: "idioms", label: "Idioms", cluster: "Culture", health: 100,
              tooltip: "Compressed cultural memory.",
              degradeOutcome: "Speech feels foreign.",
              boostOutcome: "Communication feels native.",
              roles: [
                { name: "Translators", atRisk: true },
                { name: "Elders", atRisk: false },
                { name: "Grandparents", atRisk: false }
              ]},
            { id: "taboos", label: "Taboos", cluster: "Culture", health: 100,
              tooltip: "What not to say, and how we avoid it.",
              degradeOutcome: "Social backlash. Boundaries violated.",
              boostOutcome: "Risk controlled. Limits maintained.",
              roles: [
                { name: "Editors", atRisk: true },
                { name: "PR Professionals", atRisk: false },
                { name: "Elders", atRisk: false }
              ]},
            { id: "humor", label: "Humor", cluster: "Culture", health: 100,
              tooltip: "Bonding via surprise + timing.",
              degradeOutcome: "Bonding fails. Everything tedious.",
              boostOutcome: "Connection happens. Messages stick.",
              roles: [
                { name: "Comedians", atRisk: false },
                { name: "Writers", atRisk: true },
                { name: "DJs", atRisk: false }
              ]},
            { id: "freshness", label: "Freshness", cluster: "Culture", health: 100,
              tooltip: "Staying aligned with the present.",
              degradeOutcome: "Everything feels stale.",
              boostOutcome: "Outputs feel current.",
              roles: [
                { name: "Journalists", atRisk: true },
                { name: "Youth Workers", atRisk: true },
                { name: "DJs", atRisk: false }
              ]},
            { id: "empathy", label: "Empathy", cluster: "Emotion", health: 100,
              tooltip: "Recognizing and responding to feelings.",
              degradeOutcome: "Help becomes hollow.",
              boostOutcome: "Interactions heal. People feel seen.",
              roles: [
                { name: "Therapists", atRisk: false },
                { name: "Nurses", atRisk: true },
                { name: "Caregivers", atRisk: true },
                { name: "Bartenders", atRisk: false }
              ]},
            { id: "grief", label: "Grief Language", cluster: "Emotion", health: 100,
              tooltip: "How humans speak loss.",
              degradeOutcome: "Loss handled badly.",
              boostOutcome: "Hardest moments met with grace.",
              roles: [
                { name: "Hospice Workers", atRisk: true },
                { name: "Chaplains", atRisk: false },
                { name: "Neighbors", atRisk: false }
              ]},
            { id: "hope", label: "Hope", cluster: "Emotion", health: 100,
              tooltip: "Future-making in words.",
              degradeOutcome: "Motivation dies. Futures stop.",
              boostOutcome: "Action resumes. Possibility returns.",
              roles: [
                { name: "Coaches", atRisk: false },
                { name: "Teachers", atRisk: true },
                { name: "Parents", atRisk: false }
              ]},
            { id: "shame", label: "Shame", cluster: "Emotion", health: 100,
              tooltip: "Threat to belonging.",
              degradeOutcome: "Ethics fails. Behavior unchecked.",
              boostOutcome: "Boundaries hold.",
              roles: [
                { name: "Therapists", atRisk: false },
                { name: "Elders", atRisk: false },
                { name: "Parents", atRisk: false }
              ]},
            { id: "angercontrol", label: "De-escalation", cluster: "Emotion", health: 100,
              tooltip: "Reducing heat without surrender.",
              degradeOutcome: "Conflicts spiral. Polarization accelerates.",
              boostOutcome: "Heat reduces. Solutions appear.",
              roles: [
                { name: "Moderators", atRisk: true },
                { name: "ER Nurses", atRisk: true },
                { name: "Teachers", atRisk: true }
              ]},
            { id: "taste", label: "Taste", cluster: "Judgment", health: 100,
              tooltip: "Aesthetic judgment without rules.",
              degradeOutcome: "Quality undetectable. Mediocrity.",
              boostOutcome: "Quality emerges. 'Rightness' achieved.",
              roles: [
                { name: "Curators", atRisk: true },
                { name: "Editors", atRisk: true },
                { name: "Designers", atRisk: false }
              ]},
            { id: "clarity", label: "Clarity", cluster: "Judgment", health: 100,
              tooltip: "Making meaning easy to grasp.",
              degradeOutcome: "Comprehension fails. Noise.",
              boostOutcome: "Understanding improves.",
              roles: [
                { name: "Technical Writers", atRisk: true },
                { name: "Teachers", atRisk: true },
                { name: "UX Writers", atRisk: false }
              ]},
            { id: "timing", label: "Timing", cluster: "Judgment", health: 100,
              tooltip: "When to land the point.",
              degradeOutcome: "Impact lost. Points land wrong.",
              boostOutcome: "Impact maximized.",
              roles: [
                { name: "Comedians", atRisk: false },
                { name: "Directors", atRisk: false },
                { name: "DJs", atRisk: false }
              ]},
            { id: "commonSense", label: "Common Sense", cluster: "Cognition", health: 100,
              tooltip: "Unspoken defaults about the world.",
              degradeOutcome: "Outputs feel alien. 'Weird AI.'",
              boostOutcome: "Outputs feel grounded.",
              roles: [
                { name: "Parents", atRisk: false },
                { name: "Teachers", atRisk: true },
                { name: "Grandparents", atRisk: false },
                { name: "Farmers", atRisk: true }
              ]},
            { id: "analogy", label: "Analogy", cluster: "Cognition", health: 100,
              tooltip: "Mapping one domain onto another.",
              degradeOutcome: "Hard things stay hard.",
              boostOutcome: "Complex becomes clear.",
              roles: [
                { name: "Teachers", atRisk: true },
                { name: "Coaches", atRisk: false },
                { name: "Writers", atRisk: true }
              ]},
            { id: "synthesis", label: "Synthesis", cluster: "Cognition", health: 100,
              tooltip: "Combining fragments into a whole.",
              degradeOutcome: "Insight dies. Just fragments.",
              boostOutcome: "Patterns revealed.",
              roles: [
                { name: "Researchers", atRisk: false },
                { name: "Journalists", atRisk: true },
                { name: "Consultants", atRisk: false }
              ]}
        ];

        const capacityLinks = [
            { source: "nuance", target: "hedging", type: "composed-of", weight: 0.7 },
            { source: "nuance", target: "politeness", type: "reinforces", weight: 0.5 },
            { source: "nuance", target: "trust", type: "reinforces", weight: 0.6 },
            { source: "subtext", target: "irony", type: "co-occurs", weight: 0.5 },
            { source: "subtext", target: "framing", type: "enables", weight: 0.6 },
            { source: "authority", target: "status", type: "co-occurs", weight: 0.5 },
            { source: "authority", target: "trust", type: "tensions", weight: -0.3 },
            { source: "socialproof", target: "belonging", type: "reinforces", weight: 0.6 },
            { source: "framing", target: "socialproof", type: "reinforces", weight: 0.5 },
            { source: "politeness", target: "facesaving", type: "reinforces", weight: 0.6 },
            { source: "facesaving", target: "angercontrol", type: "reinforces", weight: 0.5 },
            { source: "empathy", target: "trust", type: "reinforces", weight: 0.7 },
            { source: "empathy", target: "grief", type: "enables", weight: 0.8 },
            { source: "shame", target: "facesaving", type: "reinforces", weight: 0.5 },
            { source: "humor", target: "timing", type: "requires", weight: 0.8 },
            { source: "humor", target: "belonging", type: "reinforces", weight: 0.5 },
            { source: "memegrammar", target: "humor", type: "co-occurs", weight: 0.5 },
            { source: "idioms", target: "commonSense", type: "reinforces", weight: 0.4 },
            { source: "taboos", target: "facesaving", type: "drives", weight: 0.5 },
            { source: "freshness", target: "memegrammar", type: "feeds", weight: 0.6 },
            { source: "taste", target: "clarity", type: "balances", weight: 0.4 },
            { source: "clarity", target: "trust", type: "reinforces", weight: 0.6 },
            { source: "timing", target: "framing", type: "reinforces", weight: 0.5 },
            { source: "analogy", target: "synthesis", type: "reinforces", weight: 0.5 },
            { source: "commonSense", target: "trust", type: "supports", weight: 0.5 },
            { source: "synthesis", target: "clarity", type: "enables", weight: 0.6 },
            { source: "trust", target: "belonging", type: "reinforces", weight: 0.5 },
            { source: "trust", target: "hope", type: "enables", weight: 0.6 },
            { source: "empathy", target: "angercontrol", type: "reinforces", weight: 0.5 },
            { source: "taste", target: "nuance", type: "reinforces", weight: 0.5 },
            { source: "hope", target: "empathy", type: "reinforces", weight: 0.4 }
        ];

        const clusterCenters = {
            'Meaning': { x: 0.15, y: 0.2 },
            'Persuasion': { x: 0.5, y: 0.08 },
            'Social': { x: 0.85, y: 0.2 },
            'Culture': { x: 0.12, y: 0.65 },
            'Emotion': { x: 0.5, y: 0.78 },
            'Judgment': { x: 0.88, y: 0.65 },
            'Cognition': { x: 0.5, y: 0.42 }
        };

        const clusterColors = {
            'Meaning': '#6366f1',
            'Persuasion': '#f59e0b',
            'Social': '#10b981',
            'Culture': '#ec4899',
            'Emotion': '#ef4444',
            'Judgment': '#8b5cf6',
            'Cognition': '#06b6d4'
        };

        const linkTypeLabels = {
            'reinforces': 'reinforces',
            'enables': 'enables',
            'tensions': 'tensions',
            'composed-of': 'part of',
            'co-occurs': 'co-occurs',
            'requires': 'requires',
            'drives': 'drives',
            'feeds': 'feeds',
            'supports': 'supports',
            'balances': 'balances'
        };

        const width = window.innerWidth;
        const height = window.innerHeight;

        const svg = d3.select('#graph').attr('width', width).attr('height', height);
        const linkGroup = svg.append('g');
        const roleLineGroup = svg.append('g');
        const roleLabelGroup = svg.append('g');
        const nodeGroup = svg.append('g');

        capacityNodes.forEach(node => {
            const center = clusterCenters[node.cluster];
            node.x = center.x * width + (Math.random() - 0.5) * 50;
            node.y = center.y * height + (Math.random() - 0.5) * 50;
        });

        const simulation = d3.forceSimulation(capacityNodes)
            .force('link', d3.forceLink(capacityLinks).id(d => d.id).distance(70).strength(0.3))
            .force('charge', d3.forceManyBody().strength(-200))
            .force('center', d3.forceCenter(width / 2, height / 2))
            .force('collision', d3.forceCollide().radius(35))
            .force('x', d3.forceX(d => clusterCenters[d.cluster].x * width).strength(0.1))
            .force('y', d3.forceY(d => clusterCenters[d.cluster].y * height).strength(0.1));

        const linkElements = linkGroup.selectAll('line')
            .data(capacityLinks).join('line')
            .attr('class', 'link-capacity').attr('stroke-width', 1.5);

        const nodeElements = nodeGroup.selectAll('g')
            .data(capacityNodes).join('g')
            .attr('class', 'node-capacity health-healthy')
            .call(d3.drag().on('start', dragstarted).on('drag', dragged).on('end', dragended));

        nodeElements.append('circle').attr('class', 'health-ring-bg').attr('r', 22)
            .attr('fill', 'none').attr('stroke', '#1e293b').attr('stroke-width', 3);
        nodeElements.append('circle').attr('class', 'health-ring').attr('r', 22)
            .attr('stroke', '#22c55e').attr('stroke-dasharray', '138 138')
            .attr('stroke-dashoffset', '0').attr('transform', 'rotate(-90)');
        nodeElements.append('circle').attr('class', 'main-circle').attr('r', 17)
            .attr('fill', d => clusterColors[d.cluster]);
        nodeElements.append('text').attr('class', 'node-label').attr('dy', 30).text(d => d.label);
        nodeElements.append('text').attr('class', 'health-text').attr('dy', 3).text('100');

        let currentMode = 'view';
        let selectedNode = null;
        let draggingNode = null;
        let roleElements = { lines: [], labels: [], bgs: [] };

        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentMode = btn.dataset.mode;
            });
        });

        document.getElementById('reset-btn').addEventListener('click', () => {
            capacityNodes.forEach(n => n.health = 100);
            updateAllVisuals();
            hideAll();
        });

        nodeElements.on('click', (event, d) => {
            event.stopPropagation();
            if (currentMode === 'view') {
                selectNode(d);
            } else {
                const delta = currentMode === 'degrade' ? -25 : 25;
                d.health = Math.max(0, Math.min(100, d.health + delta));
                const cascade = calculateCascade(d, delta);
                cascade.forEach(e => {
                    const n = capacityNodes.find(x => x.id === e.id);
                    if (n) n.health = Math.max(0, Math.min(100, n.health + e.delta));
                });
                updateAllVisuals();
                showOutcome(d, cascade, currentMode);
                highlightCascade(d, cascade, currentMode);
                selectNode(d);
            }
        });

        svg.on('click', hideAll);

        function hideAll() {
            hideRoles();
            document.getElementById('info-panel').classList.remove('visible');
            document.getElementById('outcome-panel').classList.remove('visible');
            document.getElementById('drag-panel').classList.remove('visible');
            nodeElements.classed('selected', false);
            selectedNode = null;
            linkElements.classed('cascade-danger', false).classed('cascade-boost', false).classed('drag-highlight', false);
        }

        function selectNode(d) {
            hideRoles();
            selectedNode = d;
            nodeElements.classed('selected', n => n.id === d.id);
            showInfoPanel(d);
            showRoles(d);
        }

        function showRoles(cap) {
            const roles = cap.roles, num = roles.length, base = 75;
            roles.forEach((r, i) => {
                const ang = (i / num) * Math.PI * 2 - Math.PI / 2;
                const rad = base + (i % 2) * 18;
                const x = cap.x + Math.cos(ang) * rad, y = cap.y + Math.sin(ang) * rad;
                const line = roleLineGroup.append('line').attr('class', 'role-line')
                    .attr('x1', cap.x).attr('y1', cap.y).attr('x2', x).attr('y2', y);
                const tw = r.name.length * 5.5 + 10;
                const bg = roleLabelGroup.append('rect').attr('class', 'role-label-bg')
                    .attr('x', x - tw/2).attr('y', y - 7).attr('width', tw).attr('height', 14).attr('rx', 7);
                const lbl = roleLabelGroup.append('text')
                    .attr('class', `role-label ${r.atRisk ? 'at-risk' : ''}`)
                    .attr('x', x).attr('y', y + 3).text(r.name);
                roleElements.lines.push(line);
                roleElements.bgs.push(bg);
                roleElements.labels.push(lbl);
                setTimeout(() => {
                    line.classed('visible', true);
                    bg.classed('visible', true);
                    lbl.classed('visible', true);
                }, i * 35);
            });
        }

        function hideRoles() {
            roleElements.lines.forEach(e => e.remove());
            roleElements.labels.forEach(e => e.remove());
            roleElements.bgs.forEach(e => e.remove());
            roleElements = { lines: [], labels: [], bgs: [] };
        }

        function updateRolePositions() {
            if (!selectedNode) return;
            const cap = selectedNode, roles = cap.roles, num = roles.length, base = 75;
            roles.forEach((r, i) => {
                const ang = (i / num) * Math.PI * 2 - Math.PI / 2;
                const rad = base + (i % 2) * 18;
                const x = cap.x + Math.cos(ang) * rad, y = cap.y + Math.sin(ang) * rad;
                const tw = r.name.length * 5.5 + 10;
                if (roleElements.lines[i]) {
                    roleElements.lines[i].attr('x1', cap.x).attr('y1', cap.y).attr('x2', x).attr('y2', y);
                    roleElements.bgs[i].attr('x', x - tw/2).attr('y', y - 7);
                    roleElements.labels[i].attr('x', x).attr('y', y + 3);
                }
            });
        }

        function showInfoPanel(d) {
            document.getElementById('node-title').textContent = d.label;
            const badge = document.getElementById('cluster-badge');
            badge.textContent = d.cluster;
            badge.style.background = clusterColors[d.cluster];
            document.getElementById('node-tooltip').textContent = d.tooltip;
            const list = document.getElementById('roles-list');
            list.innerHTML = '';
            d.roles.forEach(r => {
                const s = document.createElement('span');
                s.className = `role-tag ${r.atRisk ? 'at-risk' : ''}`;
                s.textContent = r.name;
                list.appendChild(s);
            });
            document.getElementById('info-panel').classList.add('visible');
        }

        function showDragPanel(d) {
            draggingNode = d;
            document.getElementById('drag-node-name').textContent = d.label;
            const conns = getConnections(d);
            const depList = document.getElementById('dependency-list');
            depList.innerHTML = '';
            conns.forEach(c => {
                const item = document.createElement('div');
                item.className = 'dependency-item';
                item.innerHTML = `<span class="dep-name">${c.node.label}</span><span class="dep-type ${c.type}">${linkTypeLabels[c.type] || c.type}</span>`;
                depList.appendChild(item);
            });
            const cascade = calculateCascade(d, -25);
            const effects = document.getElementById('cascade-effects');
            effects.innerHTML = '';
            cascade.slice(0, 6).forEach(e => {
                const s = document.createElement('span');
                s.className = `cascade-effect ${e.delta > 0 ? 'positive' : ''}`;
                s.textContent = `${capacityNodes.find(n => n.id === e.id)?.label || e.id} ${e.delta > 0 ? '+' : ''}${e.delta}%`;
                effects.appendChild(s);
            });
            if (cascade.length === 0) effects.innerHTML = '<span style="color:#64748b;font-size:9px;">Minimal cascade</span>';
            const impact = (cascade.reduce((s, e) => s + e.delta, 0) - 25) / capacityNodes.length;
            const iv = document.getElementById('impact-value');
            iv.textContent = `${impact > 0 ? '+' : ''}${impact.toFixed(1)}%`;
            iv.className = `impact-value ${impact > 0 ? 'positive' : ''}`;
            document.getElementById('drag-panel').classList.add('visible');
        }

        function getConnections(node) {
            const conns = [];
            capacityLinks.forEach(l => {
                const s = l.source.id || l.source, t = l.target.id || l.target;
                if (s === node.id) {
                    const n = capacityNodes.find(x => x.id === t);
                    if (n) conns.push({ node: n, type: l.type });
                } else if (t === node.id) {
                    const n = capacityNodes.find(x => x.id === s);
                    if (n) conns.push({ node: n, type: l.type });
                }
            });
            return conns;
        }

        function calculateCascade(src, delta) {
            const effects = [], visited = new Set([src.id]);
            function prop(nid, d, depth) {
                if (depth > 3) return;
                capacityLinks.forEach(l => {
                    let tid = null, w = Math.abs(l.weight);
                    if ((l.source.id || l.source) === nid) tid = l.target.id || l.target;
                    else if ((l.target.id || l.target) === nid) tid = l.source.id || l.source;
                    if (!tid || visited.has(tid)) return;
                    let ed = l.type === 'tensions' ? -d * w * 0.4 :
                             (l.type === 'enables' || l.type === 'requires') ? d * w * 0.6 :
                             (l.type === 'reinforces' || l.type === 'supports') ? d * w * 0.5 : d * w * 0.3;
                    ed *= (1 - depth * 0.25);
                    if (Math.abs(ed) >= 3) {
                        visited.add(tid);
                        effects.push({ id: tid, delta: Math.round(ed) });
                        prop(tid, ed, depth + 1);
                    }
                });
            }
            prop(src.id, delta, 0);
            return effects;
        }

        function updateAllVisuals() {
            nodeElements.each(function(d) {
                const g = d3.select(this), h = d.health;
                let cls = `node-capacity health-${h >= 80 ? 'healthy' : h >= 50 ? 'stressed' : h >= 25 ? 'degraded' : 'critical'}`;
                if (selectedNode?.id === d.id) cls += ' selected';
                if (draggingNode?.id === d.id) cls += ' dragging';
                g.attr('class', cls);
                g.select('.health-ring').attr('stroke-dashoffset', 138 * (1 - h / 100))
                    .attr('stroke', h >= 80 ? '#22c55e' : h >= 50 ? '#fbbf24' : h >= 25 ? '#f97316' : '#ef4444');
                g.select('.health-text').text(Math.round(h));
            });
            const avg = capacityNodes.reduce((s, n) => s + n.health, 0) / capacityNodes.length;
            const col = avg >= 80 ? '#22c55e' : avg >= 50 ? '#fbbf24' : avg >= 25 ? '#f97316' : '#ef4444';
            document.getElementById('health-fill').style.width = `${avg}%`;
            document.getElementById('health-fill').style.background = col;
            document.getElementById('health-value').textContent = `${Math.round(avg)}%`;
            document.getElementById('health-value').style.color = col;
        }

        function showOutcome(node, cascade, mode) {
            const deg = mode === 'degrade';
            document.getElementById('outcome-title').textContent = `${node.label} ${deg ? 'Degraded' : 'Boosted'}`;
            document.getElementById('outcome-text').textContent = deg ? node.degradeOutcome : node.boostOutcome;
            document.querySelector('#outcome-panel .status-dot').style.background = deg ? '#ef4444' : '#22c55e';
            const items = document.getElementById('cascade-items');
            items.innerHTML = '';
            if (cascade.length) {
                cascade.forEach(e => {
                    const s = document.createElement('span');
                    s.className = `cascade-item ${e.delta > 0 ? 'boost' : ''}`;
                    s.textContent = `${capacityNodes.find(n => n.id === e.id)?.label} ${e.delta > 0 ? '+' : ''}${e.delta}%`;
                    items.appendChild(s);
                });
            } else items.innerHTML = '<span style="color:#64748b">No cascade</span>';
            document.getElementById('outcome-panel').classList.add('visible');
        }

        function highlightCascade(src, cascade, mode) {
            linkElements.classed('cascade-danger', false).classed('cascade-boost', false);
            const ids = new Set([src.id, ...cascade.map(e => e.id)]);
            linkElements.each(function(l) {
                const s = l.source.id || l.source, t = l.target.id || l.target;
                if (ids.has(s) && ids.has(t)) d3.select(this).classed(mode === 'degrade' ? 'cascade-danger' : 'cascade-boost', true);
            });
        }

        function highlightDragLinks(node) {
            const ids = new Set([node.id]);
            capacityLinks.forEach(l => {
                const s = l.source.id || l.source, t = l.target.id || l.target;
                if (s === node.id) ids.add(t);
                if (t === node.id) ids.add(s);
            });
            linkElements.classed('drag-highlight', l => {
                const s = l.source.id || l.source, t = l.target.id || l.target;
                return s === node.id || t === node.id;
            });
            nodeElements.classed('connected-drag', n => ids.has(n.id) && n.id !== node.id);
            nodeElements.classed('faded-drag', n => !ids.has(n.id));
        }

        function clearDragHighlights() {
            linkElements.classed('drag-highlight', false);
            nodeElements.classed('connected-drag', false).classed('faded-drag', false).classed('dragging', false);
        }

        simulation.on('tick', () => {
            linkElements.attr('x1', d => d.source.x).attr('y1', d => d.source.y)
                .attr('x2', d => d.target.x).attr('y2', d => d.target.y);
            nodeElements.attr('transform', d => `translate(${d.x},${d.y})`);
            if (selectedNode) updateRolePositions();
        });

        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x; d.fy = d.y;
            nodeElements.classed('dragging', n => n.id === d.id);
            highlightDragLinks(d);
            showDragPanel(d);
        }

        function dragged(event, d) { d.fx = event.x; d.fy = event.y; }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null; d.fy = null;
            clearDragHighlights();
            document.getElementById('drag-panel').classList.remove('visible');
            draggingNode = null;
            if (selectedNode) nodeElements.classed('selected', n => n.id === selectedNode.id);
        }

        window.addEventListener('resize', () => {
            const w = window.innerWidth, h = window.innerHeight;
            svg.attr('width', w).attr('height', h);
            simulation.force('center', d3.forceCenter(w / 2, h / 2)).alpha(0.3).restart();
        });

        updateAllVisuals();
    </script>
</body>
</html>
